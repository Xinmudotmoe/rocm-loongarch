pkgbase='rocm-llvm-flang'
pkgname=('rocm-llvm-flang')
pkgver=6.4.0
pkgrel=640000
pkgdesc="rocm-core is a utility which can be used to get ROCm release version."
arch=('loong64' 'x86_64' 'riscv64')
license=('Apache')
url="https://github.com/ROCm/llvm-project"
provides=('rocm-llvm-core' 'rocm-llvm-extra')
source=(
    "git+https://github.com/ROCm/llvm-project#tag=rocm-$pkgver"
)
b2sums=('SKIP')
export LD_LIBRARY_PATH=/opt/rocm-${pkgver}/lib64:$LD_LIBRARY_PATH
prepare() {
  mkdir build || true
  PATH=/opt/rocm-${pkgver}/lib/llvm/bin:$PATH
  ROCM_PATH=/opt/rocm-${pkgver}
  cat  > toolchain.cmake << EOF
set(CMAKE_BUILD_TYPE "Release")
set(CMAKE_C_FLAGS "$CFLAGS")
set(CMAKE_CXX_FLAGS "$CFLAGS")
set(CMAKE_BUILD_RPATH "/opt/rocm-${pkgver}/lib;/opt/rocm-${pkgver}/lib64;/opt/rocm-${pkgver}/lib/llvm/lib")
set(CMAKE_INSTALL_RPATH "/opt/rocm-${pkgver}/lib;/opt/rocm-${pkgver}/lib64;/opt/rocm-${pkgver}/lib/llvm/lib")
set(CMAKE_C_COMPILER "/opt/rocm-${pkgver}/lib/llvm/bin/clang")
set(CMAKE_CXX_COMPILER "/opt/rocm-${pkgver}/lib/llvm/bin/clang++")
list(APPEND CMAKE_MODULE_PATH "/opt/rocm-${pkgver}/lib/llvm/lib/cmake/mlir/")
EOF

  cd build
    cmake $PWD/../llvm-project/flang/ \
     -G Ninja \
     -DCMAKE_TOOLCHAIN_FILE=$PWD/../toolchain.cmake \
     -DCMAKE_INSTALL_PREFIX="/opt/rocm-${pkgver}/lib/llvm/" \
     -DCMAKE_BUILD_TYPE=Release \
     -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
     -DLLVM_MAIN_INCLUDE_DIR=$PWD/../llvm-project/llvm/include \
     -DLLVM_DIR=$PWD/../llvm-project \
     -DFLANG_OMP_DEVICE_ARCHITECTURES="all" \
     -DCLANG_DIR=/opt/rocm-${pkgver}/lib/llvm/lib/cmake/clang \
     -DMLIR_DIR=/opt/rocm-${pkgver}/lib/lib/cmake/mlir \
     -DLLVM_TOOLS_BINARY_DIR=/opt/rocm-${pkgver}/lib/llvm/bin/ \
     -DMLIR_TABLEGEN_EXE=/opt/rocm-${pkgver}/lib/llvm/bin/mlir-tblgen \
     -DFLANG_INCLUDE_TESTS=OFF
  cd ..

}
build() {
  cd build
    ninja 
  cd ..
}

check() {
#  cd build
#  ninja check
echo
}

#packaging() {

#}
package() {
  cd build
    cmake --install . --prefix "$pkgdir"/opt/rocm-${pkgver}/lib/llvm/
  cd ..
}

